#  Copyright 2021 Collate
#  Licensed under the Apache License, Version 2.0 (the "License");
#  you may not use this file except in compliance with the License.
#  You may obtain a copy of the License at
#  http://www.apache.org/licenses/LICENSE-2.0
#  Unless required by applicable law or agreed to in writing, software
#  distributed under the License is distributed on an "AS IS" BASIS,
#  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#  See the License for the specific language governing permissions and
#  limitations under the License.

version: "3.9"
services:  
  mysql:
    image: openmetadata/db:1.3.1
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: password
    expose:
      - 3306
    networks:
      app_net:
        ipv4_address: 172.16.240.10


  openmetadata-server:
    image: openmetadata/server:1.3.1
    restart: always
    environment:
      # LOG_LEVEL: ${LOG_LEVEL:-INFO}
      AIRFLOW_HOST: ingestion
      ELASTICSEARCH_HOSTS: elasticsearch
      # AUTHORIZER_CLASS_NAME: ${AUTHORIZER_CLASS_NAME:-org.openmetadata.service.security.DefaultAuthorizer}
      # AUTHORIZER_REQUEST_FILTER: ${AUTHORIZER_REQUEST_FILTER:-org.openmetadata.service.security.JwtFilter}
      # AUTHORIZER_ADMIN_PRINCIPALS: ${AUTHORIZER_ADMIN_PRINCIPALS:-[admin]}
      # AUTHORIZER_INGESTION_PRINCIPALS: ${AUTHORIZER_INGESTION_PRINCIPALS:-[ingestion-bot]}
      # AUTHORIZER_PRINCIPAL_DOMAIN: ${AUTHORIZER_PRINCIPAL_DOMAIN:-"openmetadata.org"}      
      # AUTHENTICATION_PROVIDER: ${AUTHENTICATION_PROVIDER:-basic}
      # AUTHENTICATION_PUBLIC_KEYS: ${AUTHENTICATION_PUBLIC_KEYS:-[http://localhost:8585/api/v1/system/config/jwks]}
      # AUTHENTICATION_AUTHORITY: ${AUTHENTICATION_AUTHORITY:-https://accounts.google.com}
      # AUTHENTICATION_CLIENT_ID: ${AUTHENTICATION_CLIENT_ID:-""}
      # AUTHENTICATION_CALLBACK_URL: ${AUTHENTICATION_CALLBACK_URL:-""}
    expose:
      - 8585
      - 3306
      - 9300
      - 9200
    ports:
      - 8585:8585
    depends_on:
      - mysql
    networks:
      app_net:
        ipv4_address: 172.16.240.13
    healthcheck:
      test: [ "CMD", "wget", "-q", "--spider",  "http://localhost:8586/healthcheck" ]
    extra_hosts:
      - "localhost:172.16.240.10"
      - "elasticsearch:172.16.240.11"

  ingestion:
    image: openmetadata/ingestion:1.3.1
    depends_on:
      - mysql
    expose:
      - 8080:8080
    networks:
      - app_net
    extra_hosts:
      - "localhost:172.16.240.10"
      - "localhost:172.16.240.11"
      - "localhost:172.16.240.13"


  elasticsearch:
    image: elasticsearch:8.12.2
    restart: always
    environment:
      - ES_JAVA_OPTS=-Xmx256m -Xms256m
      - discovery.type=single-node
    ports: 
      - 9200:9200
      - 9300:9300
    networks:
      app_net:
        ipv4_address: 172.16.240.11


networks:
  app_net:
    ipam:
      driver: default
      config:
        - subnet: "172.16.240.0/24"
